# -- Check dependency compatibility
#
# These jobs check that the minimum versions are well specified,
# and that this project is compatible with the new pre-relase
# versions of anything we can find.
#

spec:
  inputs:
    stage:
      default: test
      description: "Pipeline stage in which to add jobs"
      type: string
    pytest_options:
      default: ""
      description: "Extra options to pass to pytest"
      type: string
    minimum_python_version:
      default: "3.11"
      description: "Python version for minimum dependency compatibility check"
      type: string
    experimental_python_version:
      default: "3.12"
      description: "Python version for experimental dependency compatibility check"
      type: string

---

include:
  - local: .gitlab/ci/rules.yml

  # configure minimum dependency compatibility job
  - local: .gitlab/ci/test-job.yml
    inputs:
      stage: $[[ inputs.stage ]]
      job_name: "compat_minimum"
      install_target: "."
      pip_cmd: "uv pip"
      pip_options: "--group test --resolution lowest-direct"
      pytest_options: $[[ inputs.pytest_options ]]

  # configure experimental dependency compatibility job
  - local: .gitlab/ci/test-job.yml
    inputs:
      stage: $[[ inputs.stage ]]
      job_name: "compat_experimental"
      install_target: "."
      pip_cmd: "uv pip"
      pip_options: "--group dev --upgrade --resolution highest --prerelease allow"
      pytest_options: $[[ inputs.pytest_options ]]

.compat:
  needs: []
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip compat\]/'
      when: never
    - !reference [.rules_nightly, rules]
    - !reference [.rules_full_test, rules]
  before_script:
    - uv venv --python ${PYTHON_VERSION}
    - source .venv/bin/activate

# test against the minimum specified requirements
compat_minimum:
  extends:
    - .compat_minimum
    - .compat
  image: "ghcr.io/astral-sh/uv:python$[[ inputs.minimum_python_version ]]-bookworm"
  variables:
    PYTHON_VERSION: $[[ inputs.minimum_python_version ]]
  artifacts:
    paths:
      - .coverage*

# test against latest/pre-release versions
compat_experimental:
  extends:
    - .compat_experimental
    - .compat
  image: "ghcr.io/astral-sh/uv:python$[[ inputs.experimental_python_version ]]-bookworm"
  variables:
    PYTHON_VERSION: $[[ inputs.experimental_python_version ]]
