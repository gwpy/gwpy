# -- Quality Assurance jobs

spec:
  inputs:
    stage:
      default: test
      description: "Pipeline stage in which to add jobs"
      type: string
    project_dir:
      default: "."
      description: "Project directory to scan"
      type: string
    flake8_requirements:
      default: ""
      description: "Extra packages to install alongside flake8"
      type: string

---

include:
  - component: gitlab.com/components/sast/sast@~latest
    inputs:
      stage: $[[ inputs.stage ]]
      run_advanced_sast: true
    rules:
      - if: '$GITLAB_FEATURES =~ /\bsast_advanced\b/'
  - component: gitlab.com/components/sast/sast@~latest
    inputs:
      stage: $[[ inputs.stage ]]
      run_advanced_sast: false
    rules:
      - if: '$GITLAB_FEATURES !~ /\bsast_advanced\b/'
  - local: .gitlab/ci/rules.yml

.qa:
  extends: .rules_qa_security
  stage: $[[ inputs.stage ]]
  needs: []

gitlab-advanced-sast:
  needs: !reference [.qa, needs]
  rules:
    # skip if we just can't run advanced sast
    - if: '$GITLAB_FEATURES !~ /\bsast_advanced\b/'
      when: never
    - !reference [.qa, rules]

semgrep-sast:
  needs: !reference [.qa, needs]
  rules:
    # skip if we can run advanced sast
    - if: '$GITLAB_FEATURES =~ /\bsast_advanced\b/'
      when: never
    - !reference [.qa, rules]

flake8:
  extends: .qa
  image: python
  script:
    - python -m pip install flake8 flake8-gl-codeclimate $[[ inputs.flake8_requirements ]]
    - python -m flake8
        $[[ inputs.project_dir ]]
        --exit-zero
    - python -m flake8
        $[[ inputs.project_dir ]]
        --exit-zero
        --format gl-codeclimate
        --output-file flake8.json
  artifacts:
    reports:
      codequality: flake8.json
