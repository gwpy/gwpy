# -- Quality Assurance jobs

spec:
  inputs:
    stage:
      default: test
      description: "Pipeline stage in which to add jobs"
      type: string
    project_dir:
      default: "."
      description: "Project directory to scan"
      type: string
    requirements:
      default: ""
      description: "Extra requirements to install with pip"
      type: string
    ruff_options:
      default: ""
      description: "Extra options to pass to ruff check"
      type: string

---

include:
  - component: gitlab.com/components/sast/sast@2
    inputs:
      stage: $[[ inputs.stage ]]
  - local: .gitlab/ci/rules.yml

.qa:
  extends: .rules_qa_security
  stage: $[[ inputs.stage ]]
  needs: []

semgrep-sast:
  # NOTE: can't use 'extends' when overwriting job config
  stage: $[[ inputs.stage ]]
  needs: []
  rules: !reference [.qa, rules]

ruff:
  extends: .qa
  image: python
  script:
    - python -m pip install
          ruff
          $[[ inputs.requirements ]]
    - python -m ruff check
          $[[ inputs.ruff_options ]]
          $[[ inputs.project_dir ]]
          --exit-zero
    - python -m ruff check
          $[[ inputs.ruff_options ]]
          $[[ inputs.project_dir ]]
          --exit-zero
          --output-format gitlab
          --output-file gl-ruff.json
  artifacts:
    reports:
      codequality: gl-ruff.json
