# -- Quality Assurance jobs

spec:
  inputs:
    stage:
      default: test
      description: "Pipeline stage in which to add jobs"
      type: string
    project_dir:
      default: "."
      description: "Project directory to scan"
      type: string
    requirements:
      default: ""
      description: "Extra requirements to install with pip"
      type: string
    ruff_options:
      default: ""
      description: "Extra options to pass to ruff check"
      type: string
    mypy_options:
      default: ""
      description: "Extra options to pass to mypy"
      type: string
    python_version:
      default: "3.13"
      description: "Python version to use for testing"
      type: string
    minimum_python_version:
      default: "3.11"
      description: "Python version for minimum dependency compatibility check"
      type: string

---

include:
  - component: gitlab.com/components/dependency-scanning/main@~latest
    inputs:
      stage: $[[ inputs.stage ]]
      job_name: "dependency-scanning"
  - component: gitlab.com/components/sast/sast@~latest
    inputs:
      stage: $[[ inputs.stage ]]
      run_advanced_sast: true
    rules:
      - if: '$GITLAB_FEATURES =~ /\bsast_advanced\b/'
  - component: gitlab.com/components/sast/sast@~latest
    inputs:
      stage: $[[ inputs.stage ]]
      run_advanced_sast: false
    rules:
      - if: '$GITLAB_FEATURES !~ /\bsast_advanced\b/'
  - local: .gitlab/ci/rules.yml
  - local: .gitlab/ci/python-base.yml

.qa:
  extends: .rules_qa_security
  stage: $[[ inputs.stage ]]
  needs: []

gitlab-advanced-sast:
  needs: !reference [.qa, needs]
  rules:
    # skip if we just can't run advanced sast
    - if: '$GITLAB_FEATURES !~ /\bsast_advanced\b/'
      when: never
    - !reference [.qa, rules]

semgrep-sast:
  needs: !reference [.qa, needs]
  rules:
    # skip if we can run advanced sast
    - if: '$GITLAB_FEATURES =~ /\bsast_advanced\b/'
      when: never
    - !reference [.qa, rules]

ruff:
  extends: .qa
  image: ghcr.io/astral-sh/ruff:alpine
  script:
    - ruff check
          $[[ inputs.project_dir ]]
          $[[ inputs.ruff_options ]]
          --exit-zero
    - ruff check
          $[[ inputs.project_dir ]]
          $[[ inputs.ruff_options ]]
          --exit-zero
          --output-format gitlab
          --output-file gl-ruff.json
  artifacts:
    reports:
      codequality: gl-ruff.json

ty:
  extends: .qa
  image: ghcr.io/astral-sh/uv:debian
  variables:
    UV_MANAGED_PYTHON: 1
  script:
    # Install the project
    - uv venv --python $[[ inputs.python_version ]]
    - uv pip install -e . --group dev
    # Run ty and format for gitlab
    - uvx ty check
          $[[ inputs.project_dir ]]
          --exit-zero
          --output-format gitlab
          > gl-ty.json
    # Run ty and print to console
    - uvx ty check
          $[[ inputs.project_dir ]]
          --exit-zero
  artifacts:
    reports:
      codequality: gl-ty.json

rstcheck:
  extends:
    - .python_base
    - .qa
  image: ghcr.io/astral-sh/uv:debian
  script:
    - uvx --with rstcheck[sphinx] python .gitlab/ci/rstcheck.py > gl-rstcheck.json
    - uvx python -m json.tool gl-rstcheck.json
  artifacts:
    reports:
      codequality: gl-rstcheck.json

uv.lock:
  image: ghcr.io/astral-sh/uv:debian
  extends:
    - .qa
  script:
    # Generate uv.lock file with minimum dependencies
    - uv venv --python $[[ inputs.minimum_python_version ]]
    - uv lock --resolution lowest-direct
  artifacts:
    paths:
      - uv.lock

dependency-scanning:
  needs: ["uv.lock"]
  rules:
    # skip if we can't run advanced dependency scanning
    - if: '$GITLAB_FEATURES =~ /\bdependency_scanning\b/'
      when: never
    - !reference [.qa, rules]
