# -- Build Python project distributions

spec:
  inputs:
    stage:
      default: build
      description: "Pipeline stage in which to add jobs"
      type: string

---

include:
  - local: .gitlab/ci/rules.yml

build:
  rules: !reference [.rules_build, rules]
  needs: []
  stage: $[[ inputs.stage ]]
  image: ghcr.io/astral-sh/uv:alpine
  variables:
    # get the full history for setuptools-scm
    GIT_DEPTH: 0
    # debug setuptools-scm
    SETUPTOOLS_SCM_DEBUG: 1
  before_script:
    # need git for setuptools-scm
    - apk add --no-cache git
  script:
    - uv venv
    - uv pip install build
    - source .venv/bin/activate
    # if running a default branch push pipeline, strip the +g<HASH> suffix
    # from the version to give something that test.pypi.org will accept
    - |
      if [ "${CI_COMMIT_TAG}" = "" ] && [ "${CI_PIPELINE_SOURCE}" = "push" ] && [ "${CI_COMMIT_REF_PROTECTED}" = "true" ]; then
        export SETUPTOOLS_SCM_OVERRIDES_FOR_GWPY="{local_scheme='no-local-version'}";
      fi
    # generate the distributions
    - python -m build . -o .
    - python -m tarfile --list *.tar.*
    - python -m zipfile --list *.whl
  artifacts:
    paths:
      - "*.tar.*"
      - "*.whl"
