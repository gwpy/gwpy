# -- Basic Pytest-based test template

spec:
  inputs:
    stage:
      default: test
      description: "Pipeline stage in which to add jobs"
      type: string
    job_name:
      default: test
      description: "Name to give this job"
      type: string
    install_target:
      default: "."
      description: "Directory/distribution/package to install"
      type: string
    install_extra:
      default: "' '"
      description: "Name of the extra feature group(s) to install when installing <install_target>"
      type: string
    pip_cmd:
      default: "python -m pip"
      description: "Command to use to install packages (default: python -m pip)"
      type: string
    pip_options:
      default: ""
      description: "Extra options to pass to pip install"
      type: string
    pytest_options:
      default: ""
      description: "Extra options to pass to pytest"
      type: string
    extra_test_commands:
      default: []
      description: "Extra test commands to run (after pytest)"
      type: array

---

include:
  - local: .gitlab/ci/python-base.yml

.$[[ inputs.job_name ]]:
  extends:
    - .python_base
  variables:
    # store coverage in a file named for this job (to be combined later)
    COVERAGE_FILE: ".coverage-${CI_JOB_NAME_SLUG}"
    # cache downloaded data
    GWPY_CACHE: "1"
    # store caches in .cache
    XDG_CACHE_HOME: "$CI_PROJECT_DIR/.cache"
  script:
    # print some basic information about python
    - python --version
    - python -m site
    - python -m sysconfig
    # update pip
    - $[[ inputs.pip_cmd ]] install --upgrade "pip>=25.1"
    # create the cache directory (so that astropy will actually use it)
    # (this isn't just 'mkdir -p ...' because Windows)
    - python -c "import os;
      from pathlib import Path;
      (Path(os.getenv('XDG_CACHE_HOME')) / 'astropy').mkdir(parents=True, exist_ok=True)
      "
    # install pytest
    - $[[ inputs.pip_cmd ]] install pytest pytest-cov $[[ inputs.pip_options ]]
    # install project
    - $[[ inputs.pip_cmd ]] install $[[ inputs.install_target ]][$[[ inputs.install_extra ]]] $[[ inputs.pip_options ]]
    # list installed packages
    - $[[ inputs.pip_cmd ]] list
# run the tests
    - python -m pytest --junit-xml=junit.xml $[[ inputs.pytest_options ]]
    # run any extra tests
    - $[[ inputs.extra_test_commands ]]
    # format the coverage report
    - python -m coverage xml -o coverage.xml
  artifacts:
    reports:
      # coverage report
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      # test report
      junit: junit.xml
    paths:
      - .coverage*
  coverage: null
  cache:
    # cache Pip downloads
    - !reference [.python_base, cache]
    # cache GWpy downloaded files
    - key: "gwpy-${CI_JOB_NAME_SLUG}"
      paths:
        - .cache/astropy/download
