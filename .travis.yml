language: minimal

sudo: false
dist: trusty

env:
  global:
    secure: KXq3Kn+i5pDl7ApqYkMKAZlxC7OOLDmiBn46t/JYKyRAchacp1PR84vrwTNj7OfhZek0tlTkKwQtwpFaw6llhYSpB9xl9SsPNmoYsBtZb9zC8z/oRXlXgYudesPSt7cltlt0K21pV9gRflOezRjlJRDoccbw3pe90vYpMdvr7+0=

addons:
  apt:
    packages:
      - gcc
      - gfortran
      - libblas-dev
      - liblapack-dev
      - texlive-latex-extra
      - texlive-fonts-recommended
      - dvipng
      - libhdf5-serial-dev

python:
  - '2.7'
  - '3.5'

matrix:
  include:
    # simple build
    - env: GWPY_CI="gwpy-minimal"
      language: python
    # debian build
    - env: GWPY_CI="gwpy-debian" DOCKER_IMAGE="ligo/lalsuite-dev:jessie"
      language: minimal
      sudo: required
      services:
        - docker
    # sl7 build
    - env: GWPY_CI="gwpy-sl" DOCKER_IMAGE="ligo/lalsuite-dev:el7"
      language: minimal
      sudo: required
      services:
        - docker

  allow_failures:
    - python: '3.5'

  fast_finish: true

before_install:
  # set up utilities
  - . ./ci/lib.sh

  # configure docker and system dependencies
  - . ./ci/docker-install.sh

install:  # install package
  - ci_run "pip install ."

script:  # run tests
  - ci_run ". ./ci/test.sh"

after_success:
  # submit coverage results
  - ci_run "pip install coveralls && coveralls"

  # build and deploy package files
  - . ./ci/deploy.sh

deploy:
  - provider: pypi
    user: duncanmmacleod
    password: ${PYPI_PASSWD}
    on:
      branch: master
      tags: true
      distributions: sdist bdist_wheel
      python: '2.7'
      repo: gwpy/gwpy
  - provider: pypi
    user: duncanmmacleod
    password: ${PYPI_PASSWD}
    on:
      branch: master
      tags: true
      distributions: bdist_wheel
      python: '3.5'
      repo: gwpy/gwpy

notifications:
  slack:
    secure: jQdoSpwNbUnq0Eo7o6Ko7vuhu58LQdfy8jFKxLUnUjv/GLezK/PPAQCU9SgmyDPh1yD8sb5Xa8UtbNfGtpYdwBAGwZxPHz3oQQAflivFwcF6UP7/NlAB9muSOOnL0QfQyX1I4sIKOkX+gkl+TBciX4v58B8NUU02dDkwDqTLUqQ=

cache:
  apt: true
  pip: true
  ccache: true
before_cache:
  - rm -f $HOME/.cache/pip/log/debug.log
