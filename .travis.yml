language: python

virtualenv:
  system_site_packages: true

sudo: false

env:
  global:
    - FFTW_VERSION="3.3.4"
    - LAL_VERSION="6.15.0"
    - LALFRAME_VERSION="1.3.0"
    - LIBFRAME_VERSION="8.20"
    - LDAS_TOOLS_VERSION="2.4.1"
    - NDS2_CLIENT_VERSION="0.10.4"

addons:
  apt:
    packages:
      # generic packages
      - gcc
      - gfortran
      - python-dev
      - libblas-dev
      - liblapack-dev
      # lal dependencies
      - pkg-config
      - python-all-dev
      - zlib1g-dev
      - libgsl0-dev
      - swig
      - python-numpy
      - python-scipy
      - bc
      # nds2 dependencies
      - libsasl2-2
      # glue dependencies
      - python-m2crypto
      # misc python dependencies
      - texlive-latex-extra
      - libhdf5-serial-dev

before_install:
  # update pip
  - pip install --upgrade pip

  # build FFTW3 (double and float)
  - source .travis/build-with-autotools.sh http://www.fftw.org/fftw-${FFTW_VERSION}.tar.gz ./fftw-${FFTW_VERSION} --enable-shared=yes
  - source .travis/build-with-autotools.sh http://www.fftw.org/fftw-${FFTW_VERSION}.tar.gz ./fftw-${FFTW_VERSION} --enable-shared=yes --enable-float

  # build frame libraries
  - source .travis/build-with-autotools.sh http://software.ligo.org/lscsoft/source/ldas-tools-${LDAS_TOOLS_VERSION}.tar.gz ./ldas-tools-${LDAS_TOOLS_VERSION}
  - source .travis/build-with-autotools.sh http://software.ligo.org/lscsoft/source/libframe-${LIBFRAME_VERSION}.tar.gz ./libframe-${LIBFRAME_VERSION}

  # build LAL packages
  - source .travis/build-with-autotools.sh http://software.ligo.org/lscsoft/source/lalsuite/lal-${LAL_VERSION}.tar.gz ./lal-${LAL_VERSION}
  - source .travis/build-with-autotools.sh http://software.ligo.org/lscsoft/source/lalsuite/lalframe-${LALFRAME_VERSION}.tar.gz ./lalframe-${LALFRAME_VERSION}

  # build NDS2 client
  - source .travis/build-with-autotools.sh http://software.ligo.org/lscsoft/source/nds2-client-${NDS2_CLIENT_VERSION}.tar.gz ./nds2-client-${NDS2_CLIENT_VERSION} --disable-swig-java --disable-mex-matlab

  # build numpy and scipy
  - travis_retry pip install --install-option="--no-cython-compile" Cython
  - travis_retry pip install -q numpy==1.9.1
  - travis_wait pip install -q scipy==0.16

  # install build dependencies
  - travis_retry pip install tornado jinja2 GitPython

  # install python dependencies
  - travis_retry pip install matplotlib==1.3.1
  - travis_retry pip install astropy==1.0
  - travis_retry pip install h5py
  - travis_retry pip install unittest2
  - travis_retry pip install importlib
  - travis_retry pip install pytest
  - travis_retry pip install coveralls

  # install LSCSoft python packages
  - travis_retry pip install M2Crypto
  - travis_retry pip install kerberos
  - travis_retry pip install python-cjson
  - travis_retry pip install http://software.ligo.org/lscsoft/source/glue-1.49.1.tar.gz
  - travis_retry pip install http://software.ligo.org/lscsoft/source/dqsegdb-1.2.2.tar.gz

install:
  - python setup.py build

script:
  - coverage run --source=gwpy --omit="gwpy/tests/*,gwpy/*version*,gwpy/utils/sphinx/*" -m py.test -v
  - pip install .

after_success:
  - coveralls

notifications:
  slack:
    secure: jQdoSpwNbUnq0Eo7o6Ko7vuhu58LQdfy8jFKxLUnUjv/GLezK/PPAQCU9SgmyDPh1yD8sb5Xa8UtbNfGtpYdwBAGwZxPHz3oQQAflivFwcF6UP7/NlAB9muSOOnL0QfQyX1I4sIKOkX+gkl+TBciX4v58B8NUU02dDkwDqTLUqQ=

cache:
  directories:
    - $HOME/.cache/pip
    - ./fftw-${FFTW_VERSION}
    - ./libframe-${LIBFRAME_VERSION}
    - ./lal-${LAL_VERSION}
    - ./lalframe-${LALFRAME_VERSION}
    - ./nds2-client-${NDS2_CLIENT_VERSION}
